<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hanpanpan200.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"dimmer":false},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="Redux 是 JavaScript 状态容器，提供可预测化的状态管理。它支持 React、Angular、Ember、jQuery 甚至纯 JavaScript。 知识准备阅读本文时，你需要提前了解一下以下内容：  redux react-redux redux-thunk  这三个库中都提供了 dispatch 方法。本文以这三种不同的 dispatch 为突破口来了解 redux， re">
<meta property="og:type" content="article">
<meta property="og:title" content="Dispatch in Depth">
<meta property="og:url" content="https://hanpanpan200.github.io/2017/06/08/dispatch-in-depth/index.html">
<meta property="og:site_name" content="成长自习室">
<meta property="og:description" content="Redux 是 JavaScript 状态容器，提供可预测化的状态管理。它支持 React、Angular、Ember、jQuery 甚至纯 JavaScript。 知识准备阅读本文时，你需要提前了解一下以下内容：  redux react-redux redux-thunk  这三个库中都提供了 dispatch 方法。本文以这三种不同的 dispatch 为突破口来了解 redux， re">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hanpanpan200.github.io/images/redux-dispatch/landing.jpeg">
<meta property="og:image" content="https://hanpanpan200.github.io/images/redux-dispatch/debug.png">
<meta property="article:published_time" content="2017-06-08T07:30:33.000Z">
<meta property="article:modified_time" content="2021-04-08T10:03:37.381Z">
<meta property="article:author" content="Grace Han">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hanpanpan200.github.io/images/redux-dispatch/landing.jpeg">


<link rel="canonical" href="https://hanpanpan200.github.io/2017/06/08/dispatch-in-depth/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>Dispatch in Depth | 成长自习室</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=268383104"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '268383104');
      }
    </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">成长自习室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>站点地图</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">知识准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E5%AF%B9%E4%BD%A0%E6%98%AF%E5%90%A6%E4%BC%9A%E6%9C%89%E5%B8%AE%E5%8A%A9%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">这篇文章对你是否会有帮助？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F-Redux-%E4%B8%AD%E7%9A%84-dispatch"><span class="nav-number">3.</span> <span class="nav-text">原生 Redux 中的 dispatch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-React-%E4%B8%AD%E4%BD%BF%E7%94%A8%E2%80%9C%E7%BA%AF%E6%AD%A3%E7%9A%84%E2%80%9D-Redux"><span class="nav-number">3.1.</span> <span class="nav-text">在 React 中使用“纯正的” Redux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%80%E9%99%90-%E2%80%93-%E7%94%A8%E2%80%9C%E7%BA%AF%E6%AD%A3%E7%9A%84%E2%80%9D-Redux-%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AA%E7%BB%84%E4%BB%B6%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-number">3.2.</span> <span class="nav-text">局限 – 用“纯正的” Redux 管理多个组件的状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#react-redux-%E4%B8%AD%E7%9A%84-dispatch"><span class="nav-number">4.</span> <span class="nav-text">react-redux 中的 dispatch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#connect%E6%98%AF%E6%80%8E%E6%A0%B7%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F"><span class="nav-number">4.1.</span> <span class="nav-text">connect是怎样工作的？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#connectAdvanced-%E2%80%93-%E7%BB%91%E5%AE%9A-state-%E5%92%8C-action-creator-%E5%88%B0%E7%BB%84%E4%BB%B6%E4%B8%AD"><span class="nav-number">4.2.</span> <span class="nav-text">connectAdvanced – 绑定 state 和 action creator 到组件中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#selectorFactory-%E2%80%93-mapping-action-creator-%E5%92%8C-state-%E5%88%B0%E7%BB%84%E4%BB%B6%E7%9A%84-props-%E4%B8%AD"><span class="nav-number">4.3.</span> <span class="nav-text">selectorFactory – mapping action creator 和 state 到组件的 props 中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#context-%E2%80%93-%E4%BC%A0%E9%80%92-store-%E5%88%B0%E7%BB%84%E4%BB%B6%E6%A0%91%E4%B8%AD"><span class="nav-number">4.4.</span> <span class="nav-text">context – 传递 store 到组件树中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#react-redux-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">4.5.</span> <span class="nav-text">react-redux 的工作原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#react-thunk-%E4%B8%AD%E7%9A%84-dispatch"><span class="nav-number">5.</span> <span class="nav-text">react-thunk 中的 dispatch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E7%9A%84-action-creator"><span class="nav-number">5.1.</span> <span class="nav-text">异步的 action creator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8-redux-thunk-%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5-action-creator"><span class="nav-number">5.2.</span> <span class="nav-text">用 redux-thunk 处理异步 action creator</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Grace Han"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Grace Han</p>
  <div class="site-description" itemprop="description">思考，总结，成长，分享，改变</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://codinglife.tech/" title="https:&#x2F;&#x2F;codinglife.tech&#x2F;" rel="noopener" target="_blank">Max Peng</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/hanpanpan200" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hanpanpan200.github.io/2017/06/08/dispatch-in-depth/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Grace Han">
      <meta itemprop="description" content="思考，总结，成长，分享，改变">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="成长自习室">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Dispatch in Depth
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-06-08 15:30:33" itemprop="dateCreated datePublished" datetime="2017-06-08T15:30:33+08:00">2017-06-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-04-08 18:03:37" itemprop="dateModified" datetime="2021-04-08T18:03:37+08:00">2021-04-08</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redux/" itemprop="url" rel="index"><span itemprop="name">Redux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <img src="/images/redux-dispatch/landing.jpeg" alt="Landing" />

<p><a target="_blank" rel="noopener" href="http://cn.redux.js.org/index.html">Redux</a> 是 JavaScript 状态容器，提供可预测化的状态管理。它支持 React、Angular、Ember、jQuery 甚至纯 JavaScript。</p>
<h2 id="知识准备"><a href="#知识准备" class="headerlink" title="知识准备"></a>知识准备</h2><p>阅读本文时，你需要提前了解一下以下内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://cn.redux.js.org/index.html">redux</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/reactjs/react-redux">react-redux</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-thunk">redux-thunk</a></li>
</ul>
<p>这三个库中都提供了 dispatch 方法。<br>本文以这三种不同的 dispatch 为突破口来了解 redux， react-redux 和 redux-thunk 的工作原理。</p>
<span id="more"></span>

<h2 id="这篇文章对你是否会有帮助？"><a href="#这篇文章对你是否会有帮助？" class="headerlink" title="这篇文章对你是否会有帮助？"></a>这篇文章对你是否会有帮助？</h2><p>首先请阅读以下三段代码：</p>
<ol>
<li><code>./src/index.js</code></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./someReducer&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> store = createStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTodo</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">&#x27;ADD_TODO&#x27;</span>,</span><br><span class="line">    text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">store.dispatch(addTodo(<span class="string">&#x27;Read the docs&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2 <code>./src/containers/LinkContainer.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch, ownProps</span>) =&gt;</span> (&#123;</span><br><span class="line">  onClick: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    dispatch(setVisibilityFilter(ownProps.filter))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>3 <code>./src/actions/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getAllProducts = <span class="function">() =&gt;</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Call API to retrieve products data</span></span><br><span class="line">  shop.getProducts(<span class="function"><span class="params">products</span> =&gt;</span> &#123;</span><br><span class="line">    dispatch(receiveProducts(products))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>请注意这三段代码中都使用了 <code>dispatch</code>。现在请思考以下几个问题：</p>
<ol>
<li>以上三段代码中出现的 dispatch 分别是哪个库提供的？</li>
<li>以上三种 dispatch 有什么不同？</li>
<li>以上三段 dispatch 的使用，在 React 中分别适用于什么场景？</li>
</ol>
<p>如果以上三个问题，你并不是全部明白，请继续；反之，你可以就此停止阅读这篇文章。</p>
<h2 id="原生-Redux-中的-dispatch"><a href="#原生-Redux-中的-dispatch" class="headerlink" title="原生 Redux 中的 dispatch"></a>原生 Redux 中的 dispatch</h2><p>在 Redux 中，对 dispatch 的介绍如下：</p>
<blockquote>
<p>Dispatches an action. This is the only way to trigger a state change.</p>
</blockquote>
<blockquote>
<p>The store’s reducing function will be called with the current getState() result and the given action synchronously. Its return value will be considered the next state. It will be returned from getState() from now on, and the change listeners will immediately be notified.</p>
</blockquote>
<p>Redux 中的 <a target="_blank" rel="noopener" href="http://cn.redux.js.org/docs/basics/Store.html">store</a> 是一个对象：</p>
<ol>
<li>每个 Redux 应用中， store 只有一个</li>
<li>store 是用来维持 state 树的</li>
<li>Redux 中数据流是单向的，想要使 state 发生变化，只能通过调用 dispatch 方法来分发一个 action</li>
</ol>
<p>在“纯正的” redux 中，想要改变 store 中的 state， 需要调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">store.dispath(&#123;</span><br><span class="line">  type: <span class="string">&#x27;TODO&#x27;</span>,</span><br><span class="line">  text: <span class="string">&#x27;New todo text&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后 store 接收到传入的 action 之后，会调用 reduce 函数，返回值作为新的 state, 至此，state 得到了更新。</p>
<h3 id="在-React-中使用“纯正的”-Redux"><a href="#在-React-中使用“纯正的”-Redux" class="headerlink" title="在 React 中使用“纯正的” Redux"></a>在 React 中使用“纯正的” Redux</h3><p>在 React 中 使用 “纯正的” Redux，一共需要以下几个步骤：</p>
<ol>
<li>在组件中初始化 store</li>
<li>调用 store.subscribe(reactRenderMethod) 将 React 组件的 render 方法注册为 listener（当调用 store.dispatch 分发了一个 action 之后，就会执行组件的 render 方法来重新渲染 UI ）</li>
<li>在组件内调用 store.dispatch(actionCreator) 来改变 store 中的 state（比如：点击了 addTodo 按钮之后，调用 store.dispatch(addTodo)）</li>
<li>store.dispatch 执行之后，触发注册了的 listener，重新执行 render 方法</li>
<li>在 render 组件时，调用 store.getState() 获取最新的 state 更新到 UI 上</li>
</ol>
<h3 id="局限-–-用“纯正的”-Redux-管理多个组件的状态"><a href="#局限-–-用“纯正的”-Redux-管理多个组件的状态" class="headerlink" title="局限 – 用“纯正的” Redux 管理多个组件的状态"></a>局限 – 用“纯正的” Redux 管理多个组件的状态</h3><p>在只有一个组件的场景下，使用上述“纯正的” Redux 不失为一个简单灵活的方案。</p>
<p>但是如果组件数量大于一个，并且也需要用 Redux 来管理状态时，怎么办呢？Redux 提供了<a target="_blank" rel="noopener" href="http://redux.js.org/docs/api/bindActionCreators.html">bindActionCreators</a> 方法来解决这种问题。</p>
<p><code>bindActionCreators</code> 方法的 <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/master/src/bindActionCreators.js">源码</a> 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(actionCreator(...args))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码中可以看出，<code>bindActionCreator</code>的返回值为一个 function ，这个 function 执行时，会调用 store 的 dispatch 来分发相应的 action creator。</p>
<p>所以，我们可以用 <code>bindActionCreators</code> 来修改一下 <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/master/examples/counter">redux counter example</a> 中的 <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/master/examples/counter/src/index.js">index.js</a> 样例代码：</p>
<p>Before:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Counter <span class="keyword">from</span> <span class="string">&#x27;./components/Counter&#x27;</span></span><br><span class="line"><span class="keyword">import</span> counter <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(counter)</span><br><span class="line"><span class="keyword">const</span> rootEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> render = <span class="function">() =&gt;</span> ReactDOM.render(</span><br><span class="line">  &lt;Counter</span><br><span class="line">    value=&#123;store.getState()&#125;</span><br><span class="line">    onIncrement=&#123;<span class="function">() =&gt;</span> store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;)&#125;</span><br><span class="line">    onDecrement=&#123;<span class="function">() =&gt;</span> store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;DECREMENT&#x27;</span> &#125;)&#125;</span><br><span class="line">  /&gt;,</span><br><span class="line">  rootEl</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">render()</span><br><span class="line">store.subscribe(render)</span><br></pre></td></tr></table></figure>

<p>After:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, bindActionCreators &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Counter <span class="keyword">from</span> <span class="string">&#x27;./components/Counter&#x27;</span></span><br><span class="line"><span class="keyword">import</span> counter <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Define action creators</span></span><br><span class="line"><span class="keyword">const</span> increment = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> decrement = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: <span class="string">&#x27;DECREMENT&#x27;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create store</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(counter)</span><br><span class="line"><span class="keyword">const</span> rootEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use bindActionCreators to pass action creator wrapped into a dispatch call to a component</span></span><br><span class="line"><span class="keyword">const</span> boundIncrement = bindActionCreators(&#123; increment &#125;, store.dispatch)</span><br><span class="line"><span class="keyword">const</span> boundDecrement = bindActionCreators(&#123; decrement &#125;, store.dispatch)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> render = <span class="function">() =&gt;</span> ReactDOM.render(</span><br><span class="line">  &lt;Counter</span><br><span class="line">    value=&#123;store.getState()&#125;</span><br><span class="line">    onIncrement=&#123;<span class="function">() =&gt;</span> boundIncrement.increment()&#125;</span><br><span class="line">    onDecrement=&#123;<span class="function">() =&gt;</span> boundDecrement.decrement()&#125;</span><br><span class="line">  /&gt;,</span><br><span class="line">  rootEl</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">render()</span><br><span class="line">store.subscribe(render)</span><br></pre></td></tr></table></figure>

<p>以上的例子中，我们用 <code>bindActionCreactor</code> 把方法 <code>dispatch(actionCreator())</code> 往下传到了组件 Counter 上。但是，在实际项目中，组件的嵌套结构千变万化，比如请考虑下面这种情况：</p>
<ol>
<li>组件<code>Counter</code> 中有一个子组件 <code>A</code></li>
<li>组件<code>A</code> 中有一个子组件 <code>B</code></li>
<li>组件<code>A</code> 和 组件<code>B</code> 都需要用 Redux 做状态管理</li>
</ol>
<p>此时用这种 “纯正”的 Redux 方案的话，此时我们需要把 store 传入 A 和 B 中，并且需要完成 Redux 中的 state 和 action creator 与组件之间的绑定。即以下两步：</p>
<ol>
<li>每次 store 中的状态发生改变之后，都要更新数据到 UI 上</li>
<li>需要调用 store.dispatch 去使 store 中的数据发生改变。</li>
</ol>
<p>为了解决这个问题，<a target="_blank" rel="noopener" href="https://github.com/reactjs/react-redux">react-redux</a> 便应运而生了。</p>
<h2 id="react-redux-中的-dispatch"><a href="#react-redux-中的-dispatch" class="headerlink" title="react-redux 中的 dispatch"></a>react-redux 中的 dispatch</h2><p>回到们上面讨论的第二个代码段。（代码来自 <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/master/examples/todos/src/containers/FilterLink.js">redux todos example</a> ）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FilterLink.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; setVisibilityFilter &#125; <span class="keyword">from</span> <span class="string">&#x27;../actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;../components/Link&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state, ownProps</span>) =&gt;</span> (&#123;</span><br><span class="line">  active: ownProps.filter === state.visibilityFilter</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch, ownProps</span>) =&gt;</span> (&#123;</span><br><span class="line">  onClick: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    dispatch(setVisibilityFilter(ownProps.filter))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FilterLink = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(Link)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> FilterLink</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mapDispatchToProps 是一个入参包含了 dispatch 的 function ，因此想要了解 dispatch 是哪里来的，我们需要追踪一下 dispatch 在什么时机被谁调用了。所以我们需要把 connect 作为突破口，看看 mapDispatchToProps 在 connect 方法中进行了怎么样的处理。</p>
<h3 id="connect是怎样工作的？"><a href="#connect是怎样工作的？" class="headerlink" title="connect是怎样工作的？"></a>connect是怎样工作的？</h3><p>在 <a target="_blank" rel="noopener" href="https://github.com/reactjs/react-redux/blob/master/src/connect/connect.js">connect 方法的源码</a> 中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connect.js</span></span><br><span class="line"><span class="keyword">import</span> connectAdvanced <span class="keyword">from</span> <span class="string">&#x27;../components/connectAdvanced&#x27;</span></span><br><span class="line"><span class="keyword">import</span> defaultSelectorFactory <span class="keyword">from</span> <span class="string">&#x27;./selectorFactory&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnect</span>(<span class="params">&#123;connectHOC = connectAdvanced, ...otherProps, selectorFactory = defaultSelectorFactory&#125;</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps,&#123;...props&#125;</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">const</span> initMapDispatchToProps = match(mapDispatchToProps, mapDispatchToPropsFactories, <span class="string">&#x27;mapDispatchToProps&#x27;</span>)</span><br><span class="line">		<span class="comment">// Blah blah...</span></span><br><span class="line">		<span class="keyword">return</span> connectHOC(selectorFactory, &#123;</span><br><span class="line">			initMapDispatchToProps，</span><br><span class="line">			...otherProps</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createConnect()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看出，connect方法最终把 initMapDispatchProps 作为参数传入了 connectHOC 方法中，并将其返回。下面我们来看看 connectHOC 方法中，都做了些什么事情。</p>
<h3 id="connectAdvanced-–-绑定-state-和-action-creator-到组件中"><a href="#connectAdvanced-–-绑定-state-和-action-creator-到组件中" class="headerlink" title="connectAdvanced – 绑定 state 和 action creator 到组件中"></a>connectAdvanced – 绑定 state 和 action creator 到组件中</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connectAdvanced.js</span></span><br><span class="line"><span class="keyword">import</span> hoistStatics <span class="keyword">from</span> <span class="string">&#x27;hoist-non-react-statics&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params">selectorFactory, &#123; initMapDispatchToProps, ...otherOptions &#125;</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">		<span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">		  <span class="function"><span class="title">constructor</span>(<span class="params">props, context</span>)</span> &#123;</span><br><span class="line">		    <span class="built_in">super</span>(props, context)</span><br><span class="line">		    <span class="built_in">this</span>.store = props[storeKey] || context[storeKey]</span><br><span class="line">		    <span class="comment">// Blah blah...</span></span><br><span class="line">		    <span class="built_in">this</span>.initSelector()</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">const</span> selectorFactoryOptions = &#123; &#123;initMapDispatchToProps, ...connectOptions&#125;, ...otherOptions &#125;</span><br><span class="line">			</span><br><span class="line">			<span class="function"><span class="title">initSelector</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		    <span class="keyword">const</span> sourceSelector = selectorFactory(<span class="built_in">this</span>.store.dispatch, selectorFactoryOptions)</span><br><span class="line">		    <span class="built_in">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="built_in">this</span>.store)</span><br><span class="line">		    <span class="built_in">this</span>.selector.run(<span class="built_in">this</span>.props)</span><br><span class="line">		  &#125;	</span><br><span class="line">		&#125;		</span><br><span class="line">		<span class="keyword">return</span> hoistStatics(Connect, WrappedComponent)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上述代码中我们可以了解到，<code>connect</code> 调用之后，会返回一个 <code>function</code>，且此 <code>function</code>的入参为一个 <code>Component</code>。</p>
<p>最终返回为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hoistStatics(Connect, WrappedComponent)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/mridgway/hoist-non-react-statics">hoist-non-react-statics</a> 这个库是用来： </p>
<blockquote>
<p>Copies non-react specific statics from a child component to a parent component. Similar to Object.assign</p>
</blockquote>
<p>所以当我们调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">connect(mapStateToProps, mapDispatchToProps)(SomeComponent)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后，最终的返回值是一个复制了 SomeComponent 属性的新的 Componenent，即为我们常说的: container  component。</p>
<p>而在构造这个 container  component 时，执行了 selectorFactory 方法，将 <code>this.store.dispatch</code> 和 initMapDispatchToProps 作为参数传入。</p>
<p>此时，selectorFactory 方法中便同时可以访问到 store.dispatch 和 <code>mapDispatchToProps</code>了！让我们一起了解一下，这个方法在做什么事情吧！</p>
<h3 id="selectorFactory-–-mapping-action-creator-和-state-到组件的-props-中"><a href="#selectorFactory-–-mapping-action-creator-和-state-到组件的-props-中" class="headerlink" title="selectorFactory – mapping action creator 和 state 到组件的 props 中"></a>selectorFactory – mapping action creator 和 state 到组件的 props 中</h3><p>从 <a target="_blank" rel="noopener" href="https://github.com/reactjs/react-redux/blob/master/src/connect/selectorFactory.js">selectorFactory.js源码</a> 中我们可以知道：</p>
<ol>
<li><code>selectorFactory</code> 的入参有两个：dispatch 和其他初始化属性（包括 mapDispatchToProps）</li>
<li><code>selectorFactory</code> 会根据 <code>store.state</code> 计算出新的 <code>props</code>，并把所有的<code>actionCreator</code> 包在 dispatch 中，最终调用 <code>mergedProps</code> 把这些 props 合并后返回</li>
</ol>
<p>现在我们明白了，connect 方法会返回一个新的 container  component，并且初始化这个 container  component 时，会用 this.store.dispatch 把需要绑定的 action creator 包起来，放在 container  component 的 props 中。</p>
<p>现在又有一个新问题了，我们在这个组件中使用了 <code>this.store.dispatch</code>。 但是此前只有在 Provider 组件中传入了 store，这个 Provider 的子组件是怎么能拿到 store 的呢？</p>
<p>在生成新的container component时，构造函数中是这样为 this.store赋值的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">this</span>.store = props[storeKey] || context[storeKey]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调试的截图如下：<br><img src="/images/redux-dispatch/debug.png" alt="screenshot" /></p>
<p>可知此时的 store 来自于 <code>context</code>。</p>
<h3 id="context-–-传递-store-到组件树中"><a href="#context-–-传递-store-到组件树中" class="headerlink" title="context – 传递 store 到组件树中"></a>context – 传递 store 到组件树中</h3><p>在应用的入口，我们将 store 传入了 react-redux 中的 Provider 组件中(代码来自 <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/master/examples/todos/src/index.js">redux todos example</a> )。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./components/App&#x27;</span></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer)</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;/Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 <a target="_blank" rel="noopener" href="https://github.com/reactjs/react-redux/blob/master/src/components/Provider.js">Provider的源码</a> 中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">getChildContext</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; [storeKey]: <span class="built_in">this</span>[storeKey], [subscriptionKey]: <span class="literal">null</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props, context</span>)</span> &#123;</span><br><span class="line">	 <span class="built_in">super</span>(props, context)</span><br><span class="line">	 <span class="built_in">this</span>[storeKey] = props.store;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Blah blah...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Provider组件的构造函数中，将 <code>store</code> 放在了 <a target="_blank" rel="noopener" href="https://facebook.github.io/react/docs/context.html">context</a> 中，context 在 React 中的用法为：</p>
<blockquote>
<p>In some cases, you want to pass data through the component tree without having to pass the props down manually at every level. You can do this directly in React with the powerful “context” API.</p>
</blockquote>
<p>因此，Provider 组件通过 context 把 store 传到了以它为根节点的所有子组件中。</p>
<h3 id="react-redux-的工作原理"><a href="#react-redux-的工作原理" class="headerlink" title="react-redux 的工作原理"></a>react-redux 的工作原理</h3><p>通过以上分析，我们可以知道：</p>
<ol>
<li>在应用入口将 store 传入 Provider 组件 (用 Redux 做状态管理的组件树的根节点)</li>
<li>Provider 将 store 通过 context 传递给以它为根节点的组件树中的所有子组件</li>
<li>以 Provider 组件为根节点的组件树中的子 container  component 是通过调用 connect 之后生成的。 调用 connect 方法后，<code>react-redux</code> 会根据 PresentationalComponent 和传入的 state &amp; actionCreator 计算出新的 container  component。 在新的 container  component 中：从 context 中获取根节点组件传入的 store，包装传入的 actionCreator 为 store.dispatch(actionCreator) ，并将其绑定到组件的 props 中；将 state 绑定到组件的 props中；最终返回  container  component 。</li>
</ol>
<h2 id="react-thunk-中的-dispatch"><a href="#react-thunk-中的-dispatch" class="headerlink" title="react-thunk 中的 dispatch"></a>react-thunk 中的 dispatch</h2><p>代码段一中使用的是：“纯正”的 Redux 。<br>代码段二中使用的是： react-redux 。<br>掌握了以上两种使用方法，我们就可以基本 handle 住大部分的 redux 应用了。</p>
<h3 id="异步的-action-creator"><a href="#异步的-action-creator" class="headerlink" title="异步的 action creator"></a>异步的 action creator</h3><p>在实际项目中，异步操作的处理是很常见的，比如说：</p>
<ol>
<li>在某个页面读取文件时显示 loading 或者进度条，当文件读取成功后，展示文件。</li>
<li>发送 API 请求，当请求成功之后，展示数据。请求失败之后，显示错误消息。</li>
</ol>
<p>下面我们就用从代码段一和代码段二中学到的知识来实现下面的需求：</p>
<blockquote>
<p>根据 API server 返回的 products 数据渲染列表。</p>
</blockquote>
<p>这个处理中一共包含两个操作：</p>
<ol>
<li>发送 API 请求来获取 products 数据。</li>
<li>拿到 API 请求的返回值以后，dispatch action 来更新 store 中的 products 数据。</li>
</ol>
<p>为了把数据处理和 UI 展示分离，我们把这两个操作都放在 action 中去处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ProductsContainer.js</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    products: state.products.list,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123;</span><br><span class="line">  getAllProducts,</span><br><span class="line">  dispatch,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Products)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Products.js</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.getAllProducts(<span class="built_in">this</span>.props.dispatch)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// action.js</span></span><br><span class="line"><span class="keyword">import</span> shop <span class="keyword">from</span> <span class="string">&#x27;../utils/apiHelper&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receiveProducts</span>(<span class="params">products</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">&#x27;PRODUCTS/RECEIVE_PRODUCTS&#x27;</span>,</span><br><span class="line">    payload: products,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="function"><span class="title">getAllProducts</span>(<span class="params">dispatch</span>)</span> &#123;</span><br><span class="line">	shop.getProducts(<span class="function"><span class="params">products</span> =&gt;</span> &#123;</span><br><span class="line">		dispatch(receiveProducts(products))</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码中，dispatch 总共出现了三次：</p>
<ol>
<li><code>action.js</code> 中，<code>getAllProducts</code> 方法的入参为 <code>dispatch</code>。</li>
<li>在 <code>mapDispatchToProps</code> 方法中，把 <code>dispatch</code> 也传入了 <code>Products</code> 组件中。</li>
<li>在 <code>Products</code> 组件在调用 <code>getAllProducts</code> 方法时，把 <code>this.props.dispatch</code> 作为参数传了进去。</li>
</ol>
<p>在 “纯正的” Redux 和 “react-redux” 中，调用 dispatch 去分发一个 action creator 时，<a target="_blank" rel="noopener" href="http://redux.js.org/docs/Glossary.html#action-creator">action creator</a> 的返回值必须是一个 plain object。当 dispatch 某一个 action creator 时，react-redux 会默认帮我们执行 dispatch(actionCreator())，因此分发 action creator 时不用手动传入 dispatch 参数。</p>
<p>但是我们现在的 action creator 是一个包含了两个操作的 function。如果不手动传入 dispatch 的话, react-redux 就会在这个function 外面包上一个 dispatch 去分发 action，于是我们会得到错误：<br><code>Action can only be plain object</code></p>
<p>因此，我们可以类推出：action creator 中的异步操作将都会需要在以上三个地方加上关于 dispatch 参数传递的处理。如果你的应用足够简单，那么这样的做法就够用了。但是如果你的应用中存在很多的异步操作，恐怕就会出现大量的重复代码了。</p>
<p>那么怎样在 action creator 中处理异步的 action 呢？</p>
<p>异步的 action creator 并不会直接执行某一个函数并返回 plain action object ，而是需要在执行某个方法之后，才会返回 plain action object。</p>
<p>答案就是：<a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-thunk">redux-thunk</a></p>
<h3 id="用-redux-thunk-处理异步-action-creator"><a href="#用-redux-thunk-处理异步-action-creator" class="headerlink" title="用 redux-thunk 处理异步 action creator"></a>用 redux-thunk 处理异步 action creator</h3><p>redux-thunk 是 Redux 中解决异步 action creator 的标准方案。代码段三就是使用的这种方案。</p>
<p>redux-thunk 是一个 <a target="_blank" rel="noopener" href="http://redux.js.org/docs/advanced/Middleware.html">redux middleware</a> 。 这里有一篇关于 redux middleware 的文章 <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_two_async_operations.html">中间件与异步操作</a>，大家感兴趣的话可以查看。</p>
<blockquote>
<p>It provides a third-party extension point between dispatching an action, and the moment it reaches the reducer. People use Redux middleware for logging, crash reporting, talking to an asynchronous API, routing, and more.</p>
</blockquote>
<p>代码段三：（代码来自 <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/master/examples/shopping-cart/src/actions/index.js">redux shopping-cart example</a> ）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/actions/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getAllProducts = <span class="function">() =&gt;</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Call API to retrieve products data</span></span><br><span class="line">  shop.getProducts(<span class="function"><span class="params">products</span> =&gt;</span> &#123;</span><br><span class="line">    dispatch(receiveProducts(products))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这段代码的功能是：</p>
<p>请求API，当获取了 products 数据之后，dispatch 一个 receiveProducts 的 action 。</p>
<p>在 Redux 中，action creator 的返回值只能是 <code>plain action object</code>， 但是当用了 redux-thunk 之后，我们就可以在 action creator 中返回一个 function 了。那么这个 function 是怎样执行的呢？</p>
<p>从 <a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-thunk/blob/master/src/index.js">redux-thunk 源码</a> 来看：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createThunkMiddleware</span>(<span class="params">extraArgument</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> action(dispatch, getState, extraArgument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next(action);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = createThunkMiddleware();</span><br><span class="line">thunk.withExtraArgument = createThunkMiddleware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> thunk;</span><br></pre></td></tr></table></figure>

<p>当 dispatch(getAllProducts()) 时，middleware 会拿到下面的 action :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">  shop.getProducts(<span class="function"><span class="params">products</span> =&gt;</span> &#123;</span><br><span class="line">    dispatch(receiveProducts(products))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当判断这个 action 的类型是 function 时，会把 store 中的 <code>dispatch</code>, <code>getState</code>, <code>extraArgument</code> 一起传给这个 function (此时 dispatch 被赋值为 <code>store.dispatch</code>)，然后执行它。所以当 API 请求成功之后，可以调用 <code>dispatch(receiveProducts(products))</code>。</p>
<p>middleware 的工作原理和如何写一个 middleware 并不是本文的重点，所以暂时不在此做详细介绍。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>读到这里，你现在知道文章开头提到的三个问题的答案了吗？</p>
<p>在 React 中使用 Redux 时，<code>react-redux</code> 和 <code>redux-thunk</code> 都是官方推荐的，所以我们经常会在项目中看到各式各样的 dispatch。在定义 <code>action creator</code> 或者 调用 <code>mapDispatchToProps</code> 时有的需要把 dispatch 传入 function 中，有的却可以省略。希望本文可以让大家 <code>redux</code>，<code>react-redux</code> 和 <code>redux-thunk</code> 有更好的理解。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2017/02/08/react-native-android-share/" rel="prev" title="React Native 在 Android 中下载文件并分享">
                  <i class="fa fa-chevron-left"></i> React Native 在 Android 中下载文件并分享
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2017/07/12/icons-in-rn/" rel="next" title="Using Icons in React Native">
                  Using Icons in React Native <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Grace Han</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-606ecfc08f5e2c42" async="async"></script>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
